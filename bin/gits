#!/usr/bin/perl

use Cwd;
my $wd = getcwd;
my @args = @ARGV;
my $command = shift @args;
my ($k, $v);
my @repos;
while (my $str = pop @args) {
    if (-d $str && -d "$str/.git") {
        $str =~ s/\/$//g;
        unshift @repos, $str;
    }
    elsif ($str eq '-k') {
        $k = 1;
    }
    elsif ($str eq '-v') {
        $v = 1;
    }
    else {
        push @args, $str;
        last;
    }
}
unless(@repos){
    foreach my $str ( glob('*') ) {
        if (-d $str && -d "$str/.git") {
            push @repos, $str;
        }
    }
}
foreach my $repo (@repos) {
    chdir "$wd/$repo" or die "failed to chdir $wd/$repo";
    my @this_args = @args;
    map {s/_REPO_/$repo/} @this_args;
    open(EXEC, '-|', 'git', split(/ /, $command), @this_args);
    my $o = '';
    while (<EXEC>) {
        chomp($_);
        my $trimmed = substr($_, 0, 250);
        $trimmed .= '...'
            if !$v && length($trimmed) < length($_);
        $o .= "$trimmed\n";
    }
    close(EXEC);
    if ($? && $k) {
        print "error: $?\n" if $v;
        next;
    }
    else {
        print "=================== $repo ===================\n$o\n";
        die $? if $?;
    }
}
